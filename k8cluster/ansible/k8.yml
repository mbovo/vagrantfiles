---

- hosts: "{{ myhosts }}"
  become: true
  tasks:
    - name: "Add kubernetes repo"
      blockinfile:
        path: /etc/yum.repos.d/kubernetes.repo
        create: true
        marker: ""
        block: |
          [kubernetes]
          name=kubernetes
          baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
          enabled=1
          gpgcheck=1
          repo_gpgcheck=1
          gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
          exclude=kube*
    
    - name: "Check for swap devices"
      shell: swapon -s | grep -q dev
      register: is_swap
      changed_when: "is_swap.rc == 0"
      failed_when: "is_swap.rc > 1"

    - name: "Disabling swap"
      command: "swapoff -a"
      when: not ansible_connection == "docker" and is_swap.rc == 0

    - name: "Setting swappiness to 0"
      lineinfile:
        path: "/etc/sysctl.conf"
        line: "vm.swappiness = 0"
        create: yes
        state: present
      when: is_swap.rc == 0

    - name: "Load kernel modules"
      command: "modprobe {{item}}"
      with_items:
        - br_netfilter

    - stat:
        path: "/etc/fstab.bak"
      register: fstab_backup

    - name: "Backup copy of fstab"
      copy:
        src: "/etc/fstab"
        dest: "/etc/fstab.bak"
        remote_src: True
      when: fstab_backup.stat and not fstab_backup.stat.exists

    - name: "Remove swap from fstab"
      lineinfile:
        path: "/etc/fstab"
        regexp: "^/dev.*swap"
        state: absent
      when: is_swap.rc == 0

    - include: "selinux.yml"

    - name: "Installing kubernetes binaries"
      shell: yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

    - name: "Enable kubelet"
      systemd:
        name: kubelet
        state: stopped
        enabled: true